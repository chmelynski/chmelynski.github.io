function MakeGraph(){var a={};a.display=DisplayGraph;a.displayLabel=DisplayCell;a.displayNode=DisplayCell;a.displayEdge=DisplayEdge;a.nodes=[];a.edges=[];return a}function MakeNode(b){var a={};a.ins=[];a.ous=[];a.contents=b;return a}function AddNode(b,a){a.parent=b;b.nodes.push(a)}function AddEdge(c,d,e,a){var b={};b.src=d;b.dst=e;b.label=a;b.parent=c;d.ous.push(b);e.ins.push(b);c.edges.push(b)}function GenerateForces(c,h){var d=[];var l=null;for(var k in c){for(var g in c){var o=c[k];var n=c[g];if(o!=n){l=MakeForce(o,n,1);d.push(l)}}}for(var k in h){var m=h[k];l=MakeForce(m.src,m.dst,-1);d.push(l);l=MakeForce(m.dst,m.src,-1);d.push(l)}return d}function ApplyForces(b,a){for(var c in b){var e=b[c];var d=e.node;Set(d.cx,Get(d.cx)+e.vx);Set(d.cy,Get(d.cy)+e.vy)}}function MakeForce(f,c,e){var g=Get(c.cx)-Get(f.cx);var d=Get(c.cy)-Get(f.cy);var j=Math.sqrt(g*g+d*d);var i=0;if(e>0){i=-1*globals.charge/(j*j)}else{if(e<0){i=(j-globals.optimalSpringLength)/globals.springStiffness}}var h={};h.node=f;h.vx=i*g/j;h.vy=i*d/j;return h}function IsConnectedTo(f,d,c){for(var g in f){if(g.from==d&&g.to==c||g.to==d&&g.from==c){return true}}return false}function Displace(f,h,e){var c=Math.atan2(h.y-f.y,h.x-f.x);var a=f.x+e*Math.cos(c);var g=f.y+e*Math.sin(c);var b={};b.x=a;b.y=g;return b}function Distance(d,c){return Math.sqrt((c.x-d.x)*(c.x-d.x)+(c.y-d.y)*(c.y-d.y))}function Angle(d,c){return Math.atan2(-(c.y-d.y),c.x-d.x)}function DisplayGraph(j,k,h,g){var f={};AddRectSlots(f);f.parentSelect=ParentSelectGraphShape;f.parentDeselect=ParentDeselectGraphShape;f.displayNode=k;f.displayEdge=h;f.displayLabel=g;f.draw=DrawGraph;f.click=ClickGraph;f.position=PositionGraph;f.data=j;f.code=MakeGraph();f.nodeShapes=[];f.edgeShapes=[];for(var e in j.nodes){var c=j.nodes[e];var d=k(c);f.nodeShapes.push(d);d.parentShape=f;d.stroke="rgb(158,182,206)";d.dx=MakeSlot(d.code,0);d.dy=MakeSlot(d.code,0)}for(var e in j.edges){var b=j.edges[e];var a=h(j,f,b);f.edgeShapes.push(a);a.parentShape=f}return f}function PositionGraph(d){for(var e in d.nodeShapes){var c=d.nodeShapes[e];Set(c.left,Get(d.left)+Get(c.dx));Set(c.right,Get(c.left)+Get(c.width));Set(c.wr,Get(c.width)/2);Set(c.cx,Get(c.left)+Get(c.wr));Set(c.top,Get(d.top)+Get(c.dy));Set(c.bottom,Get(c.top)+Get(c.height));Set(c.hr,Get(c.height)/2);Set(c.cy,Get(c.top)+Get(c.hr));c.position(c)}for(var e in d.edgeShapes){var a=d.edgeShapes[e];var f={x:Get(a.src.dx),y:Get(a.src.dy)};var k={x:Get(a.dst.dx),y:Get(a.dst.dy)};var h={x:Get(a.cps[1].dx),y:Get(a.cps[1].dy)};var b={x:Get(a.cps[2].dx),y:Get(a.cps[2].dy)};var j=Displace(f,h,d.standoff);var g=Displace(k,b,d.standoff);Set(a.cps[0].dx,j.x);Set(a.cps[0].dy,j.y);Set(a.cps[3].dx,g.x);Set(a.cps[3].dy,g.y);Set(a.cps[0].cx,Get(d.left)+Get(a.cps[0].dx));Set(a.cps[0].cy,Get(d.top)+Get(a.cps[0].dy));Set(a.cps[1].cx,Get(d.left)+Get(a.cps[1].dx));Set(a.cps[1].cy,Get(d.top)+Get(a.cps[1].dy));Set(a.cps[2].cx,Get(d.left)+Get(a.cps[2].dx));Set(a.cps[2].cy,Get(d.top)+Get(a.cps[2].dy));Set(a.cps[3].cx,Get(d.left)+Get(a.cps[3].dx));Set(a.cps[3].cy,Get(d.top)+Get(a.cps[3].dy));a.position(a)}}function ForceDirectedLayout(e){RandomLayout(e);for(var b=0;b<50;b++){var a=GenerateForces(e.nodeShapes,e.edgeShapes);ApplyForces(a,e.nodeShapes)}for(var b in e.nodeShapes){var d=e.nodeShapes[b];Set(d.left,Get(d.cx)-Get(d.wr));Set(d.right,Get(d.cx)+Get(d.wr));Set(d.top,Get(d.cy)-Get(d.hr));Set(d.bottom,Get(d.cy)+Get(d.hr))}for(var b in e.edgeShapes){var c=e.edgeShapes[b]}}function RandomLayout(f){var h=Get(f.left);var g=Get(f.top);var c=Get(f.width);var a=Get(f.height);for(var b in f.nodeShapes){var e=f.nodeShapes[b];Set(e.dx,Math.floor(Math.random()*(c-Get(e.width))));Set(e.dy,Math.floor(Math.random()*(a-Get(e.height))))}for(var b in f.edgeShapes){var d=f.edgeShapes[b];Set(d.cps[1].dx,Math.floor(Math.random()*c));Set(d.cps[1].dy,Math.floor(Math.random()*a));Set(d.cps[2].dx,Math.floor(Math.random()*c));Set(d.cps[2].dy,Math.floor(Math.random()*a))}}function DisplayEdge(l,e,c){var d={};d.draw=DrawBezier;d.lineWidth=1;d.stroke="rgb(0,0,0)";d.points=[];d.points.push({x:null,y:null});d.points.push({x:null,y:null});d.points.push({x:null,y:null});d.points.push({x:null,y:null});var j={};j.draw=DrawPath;j.lineWidth=1;j.stroke="rgb(0,0,0)";j.points=[];j.points.push({x:null,y:null});j.points.push({x:null,y:null});var g={};g.draw=DrawPath;g.lineWidth=1;g.stroke="rgb(0,0,0)";g.points=[];g.points.push({x:null,y:null});g.points.push({x:null,y:null});var h=[];for(var f=0;f<4;f++){var k={};k.draw=DrawArc;k.click=ClickArc;k.stroke=null;k.fill="rgb(242,149,54)";k.radius=5;k.startAngle=0;k.endAngle=2*Math.PI;k.lineWidth=1;k.cx=MakeSlot(e.code,null);k.cy=MakeSlot(e.code,null);k.dx=MakeSlot(e.code,null);k.dy=MakeSlot(e.code,null);k.onhover=PrimeDrag;h.push(k)}var b=null;if(c.label.display){b=c.label.display(c.label);b.dx=10;b.dy=10;b.referencePoint=a.cps[1]}var a={};a.draw=DrawEdge;a.click=ClickEdge;a.position=PositionEdge;a.data=c;a.cps=h;a.bezier=d;a.rfletch=j;a.lfletch=g;a.labelShape=b;a.src=e.nodeShapes[l.nodes.indexOf(c.src)];a.dst=e.nodeShapes[l.nodes.indexOf(c.dst)];return a}function PositionEdge(a){var m={x:Get(a.cps[0].cx),y:Get(a.cps[0].cy)};var l={x:Get(a.cps[1].cx),y:Get(a.cps[1].cy)};var j={x:Get(a.cps[2].cx),y:Get(a.cps[2].cy)};var i={x:Get(a.cps[3].cx),y:Get(a.cps[3].cy)};a.bezier.points[0].x=m.x;a.bezier.points[0].y=m.y;a.bezier.points[1].x=l.x;a.bezier.points[1].y=l.y;a.bezier.points[2].x=j.x;a.bezier.points[2].y=j.y;a.bezier.points[3].x=i.x;a.bezier.points[3].y=i.y;var g=10;var h=10;var b=30;var k=Displace(m,l,g);var e=Displace(i,j,g);var d=Angle(j,i);var c=d+b/360*2*Math.PI;var f=d-b/360*2*Math.PI;a.rfletch.points[0].x=i.x;a.rfletch.points[0].y=i.y;a.rfletch.points[1].x=i.x-(h*Math.cos(c));a.rfletch.points[1].y=i.y+(h*Math.sin(c));a.lfletch.points[0].x=i.x;a.lfletch.points[0].y=i.y;a.lfletch.points[1].x=i.x-(h*Math.cos(f));a.lfletch.points[1].y=i.y+(h*Math.sin(f));if(a.labelShape){Set(a.labelShape.left,Get(a.labelShape.referencePoint.cx)+Get(a.labelShape.dx));Set(a.labelShape.top,Get(a.labelShape.referencePoint.cy)+Get(a.labelShape.dy));Set(a.labelShape.right,Get(a.labelShape.left)+Get(a.labelShape.width));Set(a.labelShape.wr,Get(a.labelShape.width)/2);Set(a.labelShape.cx,Get(a.labelShape.left)+Get(a.labelShape.wr));Set(a.labelShape.bottom,Get(a.labelShape.top)+Get(a.labelShape.height));Set(a.labelShape.hr,Get(a.labelShape.height)/2);Set(a.labelShape.cy,Get(a.labelShape.top)+Get(a.labelShape.hr));a.labelShape.position(a.labelShape)}}function OnFocusGraphShape(a){Push("Alt+N",NewNode);Push("Alt+E",NewEdge)}function DeFocusGraphShape(a){Pop("Alt+N");Pop("Alt+E")}function DrawGraph(a){DrawBox(a);for(var b in a.nodeShapes){a.nodeShapes[b].draw(a.nodeShapes[b])}for(var b in a.edgeShapes){a.edgeShapes[b].draw(a.edgeShapes[b])}}function DrawEdge(a){for(var b in a.cps){a.cps[b].draw(a.cps[b])}a.bezier.draw(a.bezier);a.rfletch.draw(a.rfletch);a.lfletch.draw(a.lfletch);if(a.labelShape){a.labelShape.draw(a.labelShape)}}function ClickGraph(f){for(var d=f.edgeShapes.length-1;d>=0;d--){var a=f.edgeShapes[d];if(a.click){var e=a.click(a);if(e){return e}}}for(var d=f.nodeShapes.length-1;d>=0;d--){var a=f.nodeShapes[d];if(a.click){var e=a.click(a);if(e){return e}}}var j=Get(globals.mx);var h=Get(globals.my);var c=Get(f.left);var b=Get(f.width);var g=Get(f.top);var k=Get(f.height);if(c<j&&j<c+b&&g<h&&h<g+k){return f}else{return null}}function ClickEdge(a){var e=[a.cps[1],a.cps[2]];for(var b=e.length-1;b>=0;b--){var c=e[b];if(c.click){var d=c.click(c);if(d){return d}}}if(a.labelShape){if(a.labelShape.click){var d=a.labelShape.click(a.labelShape);if(d){return d}}}}function DisplayGrid(b){var c={};AddRectSlots(c);c.editActive=EditActiveGrid;c.parentSelect=ParentSelectGridShape;c.parentDeselect=ParentDeselectGridShape;c.draw=DrawGrid;c.click=ClickGrid;c.data=b;c.position=PositionGrid;c.nRows=b.rows.length;c.nCols=b.cols.length;c.selectionExtentCell={row:null,col:null};c.active={row:null,col:null};c.selected={left:null,top:null,right:null,bottom:null};c.cells=[];c.rowLabelCells=[];c.colLabelCells=[];c.colWidths=[];c.rowHeights=[];c.rowLabelWidth=64;c.colLabelHeight=20;for(var g=0;g<c.nCols;g++){c.colWidths.push(64)}for(var g=0;g<c.nRows;g++){c.rowHeights.push(20)}c.cells=new Array(c.nCols*c.nRows);for(var d=0;d<b.objs.length;d++){for(var h=0;h<b.fields.length;h++){var a=MakePointer(c.code).contents;a.name=b.fields[h];a.scope=b.obj[b.objs[d]];a[0]=a.scope[a.name];var l=DisplayCell(a);l.stroke="rgb(208,215,229)";l.parentShape=c;if(b.cols==b.objs){c.cells[d*c.nRows+h]=l;l.row=h;l.col=d}else{c.cells[h*c.nRows+d]=l;l.row=d;l.col=h}}}for(var g in b.rows){var k=MakeSlot(c.code,GridLabelToString(b.rows[g])).contents;var l=DisplaySlotAsCell(k);l.fill="rgb(228,236,247)";l.stroke="rgb(158,182,206)";l.parentShape=c;c.rowLabelCells.push(l)}for(var e in b.cols){var k=MakeSlot(c.code,GridLabelToString(b.cols[e])).contents;var l=DisplaySlotAsCell(k);l.fill="rgb(228,236,247)";l.stroke="rgb(158,182,206)";l.parentShape=c;c.colLabelCells.push(l)}return c}function PositionGrid(e){var b=Get(e.left);var f=Get(e.top);f+=Get(e.colLabelHeight);for(var d in e.rowLabelCells){var a=e.rowLabelCells[d];SizeBox(a,"width","left",Get(e.rowLabelWidth)+1);SizeBox(a,"height","top",Get(e.rowHeights[d])+1);MoveBox(a,"left",b);MoveBox(a,"top",f);a.position(a);f+=Get(e.rowHeights[d])}b=Get(e.left);f=Get(e.top);b+=Get(e.rowLabelWidth);for(var c in e.colLabelCells){var a=e.colLabelCells[c];SizeBox(a,"width","left",Get(e.colWidths[c])+1);SizeBox(a,"height","top",Get(e.colLabelHeight)+1);MoveBox(a,"left",b);MoveBox(a,"top",f);a.position(a);b+=Get(e.colWidths[c])}b=Get(e.left);b+=Get(e.rowLabelWidth);for(var c=0;c<e.nCols;c++){f=Get(e.top);f+=Get(e.colLabelHeight);for(var d=0;d<e.nRows;d++){var a=e.cells[c*e.nRows+d];SizeBox(a,"width","left",Get(e.colWidths[c])+1);SizeBox(a,"height","top",Get(e.rowHeights[d])+1);MoveBox(a,"left",b);MoveBox(a,"top",f);a.position(a);f+=Get(e.rowHeights[d])}b+=Get(e.colWidths[c])}}function DrawGrid(e){for(var d in e.cells){var l=e.cells[d];l.draw(l)}for(var d in e.rowLabelCells){if(e.hasSelected&&e.selected.top<=d&&d<=e.selected.bottom){}else{var l=e.rowLabelCells[d];l.fill="rgb(228,236,247)";l.stroke="rgb(158,182,206)";l.draw(l)}}for(var c in e.colLabelCells){if(e.hasSelected&&e.selected.left<=c&&c<=e.selected.right){}else{var l=e.colLabelCells[c];l.fill="rgb(228,236,247)";l.stroke="rgb(158,182,206)";l.draw(l)}}if(e.hasSelected){for(var d in e.rowLabelCells){if(e.selected.top<=d&&d<=e.selected.bottom){var l=e.rowLabelCells[d];l.fill="rgb(255,213,141)";l.stroke="rgb(242,149,54)";l.draw(l)}}for(var c in e.colLabelCells){if(e.selected.left<=c&&c<=e.selected.right){var l=e.colLabelCells[c];l.fill="rgb(255,213,141)";l.stroke="rgb(242,149,54)";l.draw(l)}}}if(e.hasSelected){var b=0;var k=0;var g=0;var a=0;var h=Get(e.left);var f=Get(e.top);h+=Get(e.rowLabelWidth);f+=Get(e.colLabelHeight);for(var d=0;d<=e.selected.right;d++){if(d==e.selected.left){b=h}h+=Get(e.colWidths[d])}k=h;for(var d=0;d<=e.selected.bottom;d++){if(d==e.selected.top){g=f}f+=Get(e.rowHeights[d])}a=f;DrawActiveBorder(b,g,k,a)}}function ClickGrid(b){for(var c in b.rowLabelCells){var a=b.rowLabelCells[c];var d=a.click(a);if(d){return d}}for(var c in b.colLabelCells){var a=b.colLabelCells[c];var d=a.click(a);if(d){return d}}for(var c in b.cells){var a=b.cells[c];var d=a.click(a);if(d){return d}}}function GridLabelToString(a){if(typeof(a)=="string"||typeof(a)=="number"){return a.toString()}else{return"obj"}}function OnFocusGridShape(a){a.active.row=0;a.active.col=0;a.selectionExtentCell.row=0;a.selectionExtentCell.col=0;a.selected.top=0;a.selected.bottom=0;a.selected.left=0;a.selected.right=0;Push("Up",MoveActiveUp);Push("Down",MoveActiveDown);Push("Enter",MoveActiveDown);Push("Right",MoveActiveRight);Push("Left",MoveActiveLeft);Push("Shift+Up",ExtendSelectionUp);Push("Shift+Down",ExtendSelectionDown);Push("Shift+Right",ExtendSelectionRight);Push("Shift+Left",ExtendSelectionLeft);Push("Ctrl+Up",MoveActiveAllTheWayUp);Push("Ctrl+Down",MoveActiveAllTheWayDown);Push("Ctrl+Right",MoveActiveAllTheWayRight);Push("Ctrl+Left",MoveActiveAllTheWayLeft);Push("Shift+Ctrl+Up",ExtendSelectionAllTheWayUp);Push("Shift+Ctrl+Down",ExtendSelectionAllTheWayDown);Push("Shift+Ctrl+Right",ExtendSelectionAllTheWayRight);Push("Shift+Ctrl+Left",ExtendSelectionAllTheWayLeft);Push("Ctrl+Space",SelectWholeCol);Push("Shift+Space",SelectWholeRow);Push("Shift+Ctrl+Space",SelectWholeGrid)}function DeFocusGridShape(a){Pop("Up");Pop("Down");Pop("Enter");Pop("Right");Pop("Left");Pop("Shift+Up");Pop("Shift+Down");Pop("Shift+Right");Pop("Shift+Left");Pop("Ctrl+Up");Pop("Ctrl+Down");Pop("Ctrl+Right");Pop("Ctrl+Left");Pop("Shift+Ctrl+Up");Pop("Shift+Ctrl+Down");Pop("Shift+Ctrl+Right");Pop("Shift+Ctrl+Left");Pop("Ctrl+Space");Pop("Shift+Space");Pop("Shift+Ctrl+Space")}function EditActiveGrid(b,a,c){if(c){b.hasSelected=true;b.active.row=a.row;b.active.col=a.col;b.selectionExtentCell.row=a.row;b.selectionExtentCell.col=a.col;b.selected.top=a.row;b.selected.bottom=a.row;b.selected.left=a.col;b.selected.right=a.col}else{b.hasSelected=false;b.active.row=null;b.active.col=null;b.selectionExtentCell.row=null;b.selectionExtentCell.col=null;b.selected.top=null;b.selected.bottom=null;b.selected.left=null;b.selected.right=null}}function DisplayCell(b){var a={};a.draw=DrawCell;a.click=ClickBox;a.state="blank";a.pointer=b;a.act=RedisplayCellString;a.tostring=ToStringDefault;a.position=PositionCell;a.display=DisplayCell;a.align=typeof(Get(b))=="number"?"right":"left";a.contents=[];a.string=null;a.lineWidth=1;a.stroke="rgb(0,0,0)";a.fill=null;a.textFill="rgb(0,0,0)";AddRectSlots(a);a.onhover=OnHoverCell;a.dehover=DeHoverCell;a.onselect=OnSelectCell;a.deselect=DeSelectCell;SizeBox(a,"width","cx",64);SizeBox(a,"height","cy",20);a.cursorOn=false;a.cursorTimer=null;a.toggleCursor=function(){a.cursorOn=!a.cursorOn};RecalculateCellString(a);RedisplayCellString(a);return a}function PositionCell(l){var b=Get(l.left);var j=Get(l.top);var k=Get(l.right);var a=Get(l.bottom);var f=b+3;var m=j+1;var e=globals.g;for(var d=0;d<l.contents.length;d++){var h=l.contents[d];if(h.c=="\n"){f=b+3;m+=19;h.invisible=true}else{if(h.c=="\r"){h.invisible=true}else{if(h.c=="\t"){f+=30;h.invisible=true}else{e.font=h.font;h.width=e.measureText(h.c).width;h.height=19;h.wr=h.width/2;h.hr=h.height/2;h.left=f;h.right=h.left+h.width;if(h.right>=k-1){f=b+3;m+=h.height;h.left=f;h.right=h.left+h.width}h.top=m;h.bottom=h.top+h.height;h.cx=h.left+h.wr;h.cy=h.top+h.hr;if(h.left>b&&h.right<k&&h.top>j&&h.bottom<a){h.invisible=false}else{h.invisible=true}f+=h.width}}}}}function DrawCell(b){DrawBox(b);if(b.cursorOn){var a=null;var d=null;var c=null;if(b.cursorPosInString==-1){a=Get(b.left)+2;d=Get(b.top)+2;c=Get(b.top)+17}else{a=Get(b.contents[b.cursorPosInString].right);d=Get(b.contents[b.cursorPosInString].top)+2;c=Get(b.contents[b.cursorPosInString].bottom)-2}a=Math.floor(a)+0.5;var e=globals.g;e.lineWidth=1;e.strokeStyle="rgb(0,0,0)";e.beginPath();e.moveTo(a,d);e.lineTo(a,c);e.stroke()}if(globals.selectedCellShape==b){DrawActiveBorder(Get(b.left),Get(b.top),Get(b.right),Get(b.bottom))}}function OnHoverCell(a){Push("LD",Select)}function DeHoverCell(a){Pop("LD")}function OnSelectCell(a){a.parentShape.parentSelect(a.parentShape);a.parentShape.editActive(a.parentShape,a,true);PushAlpha(DeleteAndPrimeTextEditAndAddChar);Push("Space",DeleteAndPrimeTextEditAndAddChar);Push("F2",PrimeTextEdit);Push("Delete",Delete);Push("Esc",Deselect)}function DeSelectCell(a){a.parentShape.parentDeselect(a.parentShape);a.parentShape.editActive(a.parentShape,a,false);PopAlpha();Pop("Space");Pop("F2");Pop("Delete");Pop("Esc")}function RecalculateCellString(a){var b=Get(a.pointer);a.valueType=typeof(b);if(b==null){a.string=""}else{if(a.valueType=="number"){a.string=b.toFixed(1)}else{if(a.valueType=="string"||a.valueType=="object"){a.string=a.tostring(b)}else{a.string=""}}}}function RedisplayCellString(a){a.contents=[];for(var d=0;d<a.string.length;d++){var g={};g.c=a.string[d];g.draw=DrawText;g.click=ClickBox;g.cell=a;g.type="text";g.font="11pt Calibri";g.stroke=null;g.fill=a.textFill;g.width=null;g.height=null;g.left=null;g.top=null;g.right=null;g.bottom=null;g.wr=null;g.hr=null;g.cx=null;g.cy=null;g.scale=null;if(a.valueType=="number"&&IsDigit(g.c)){g.onhover=OnHoverDigit;g.dehover=DeHoverDigit}else{g.onhover=OnHoverNonDigit;g.dehover=DeHoverNonDigit}a.contents.push(g)}if(a.valueType=="number"){var f=false;for(var d=0;d<a.contents.length;d++){if(a.contents[d].c=="."){var e=1;for(var b=d-1;b>=0;b--){a.contents[b].scale=e;e*=10}e=0.1;for(var b=d+1;b<a.contents.length;b++){a.contents[b].scale=e;e/=10}f=true;break}}if(!f){var e=1;for(var b=a.contents.length-1;b>=0;b--){a.contents[b].scale=e;e*=10}}}}function DisplaySlotAsCell(a){return DisplayCell(MakePointer(a.node.parent,a).contents)}function DisplayStringAsCell(a){return DisplayCell(MakePointer(null,MakeSlot(null,a).contents).contents)}function ToStringDefault(a){return a.toString()}function DrawBox(h){if(h.invisible){return}var f=globals.g;var c=Get(h.left);var j=Get(h.top);var b=Get(h.width);var l=Get(h.height);var k=Get(h.right);var a=Get(h.bottom);if(c>window.scrollX+window.innerWidth){return}if(k<window.scrollX){return}if(j>window.scrollY+window.innerHeight){return}if(a<window.scrollY){return}var n=Get(h.fill);var m=Get(h.stroke);var e=Get(h.lineWidth);if(n){f.fillStyle=n;f.fillRect(c,j,b,l)}if(m){if(e){f.lineWidth=e}else{f.lineWidth=1}f.strokeStyle=m;f.strokeRect(c+0.5,j+0.5,b-1,l-1)}if(h.contents){for(var d in h.contents){if(h.contents[d].draw){h.contents[d].draw(h.contents[d])}}}}function DrawText(b){if(b.invisible){return}var d=globals.g;var e=Get(b.left);var a=Get(b.bottom);var f=Get(b.c);d.font=Get(b.font);d.fillStyle=Get(b.fill);d.fillText(f,e,a-4)}function DrawPath(b){var d=globals.g;d.lineWidth=Get(b.lineWidth);d.strokeStyle=Get(b.stroke);var a=Get(b.points[0].x);var e=Get(b.points[0].y);d.beginPath();d.moveTo(a,e);for(var c=1;c<b.points.length;c++){a=Get(b.points[c].x);e=Get(b.points[c].y);d.lineTo(a,e)}d.stroke()}function DrawLinepath(a){var h=globals.g;h.lineWidth=Get(a.lineWidth);h.strokeStyle=Get(a.stroke);for(var d=0;d<a.points.length-1;d++){var c=Get(a.points[d].x);var f=Get(a.points[d].y);var b=Get(a.points[d+1].x);var e=Get(a.points[d+1].y);h.beginPath();h.moveTo(c,f);h.lineTo(b,e);h.stroke()}}function DrawPolygon(b){var d=globals.g;d.lineWidth=Get(b.lineWidth);d.strokeStyle=Get(b.stroke);var e=Get(b.fill);if(e){d.fillStyle=e}var a=Get(b.points[0].x);var f=Get(b.points[0].y);d.beginPath();d.moveTo(a,f);for(var c=1;c<b.points.length;c++){a=Get(b.points[c].x);f=Get(b.points[c].y);d.lineTo(a,f)}d.closePath();d.stroke()}function DrawBezier(f){var e=globals.g;e.lineWidth=Get(f.lineWidth);e.strokeStyle=Get(f.stroke);var d=Get(f.points[0].x);var k=Get(f.points[0].y);var c=Get(f.points[1].x);var j=Get(f.points[1].y);var b=Get(f.points[2].x);var i=Get(f.points[2].y);var a=Get(f.points[3].x);var h=Get(f.points[3].y);e.beginPath();e.moveTo(d,k);e.bezierCurveTo(c,j,b,i,a,h);e.stroke()}function DrawArc(i){var d=globals.g;var e=Get(i.lineWidth);var j=Get(i.stroke);var k=Get(i.fill);if(k){d.fillStyle=k}if(j){if(e){d.lineWidth=e}else{d.lineWidth=1}d.strokeStyle=j}var c=Get(i.cx);var b=Get(i.cy);var f=Get(i.radius);var h=Get(i.startAngle);var a=Get(i.endAngle);d.beginPath();d.arc(c,b,f,h,a,true);d.closePath();d.fill()}function DrawActiveBorder(d,c,b,a){globals.g.fillStyle="rgb(0,0,0)";globals.g.fillRect(d-1,c-1,b-d,3);globals.g.fillRect(d-1,a-1,b-d-2,3);globals.g.fillRect(d-1,c-1,3,a-c);globals.g.fillRect(b-1,c-1,3,a-c-2);globals.g.fillRect(b-2,a-2,5,5)}function DrawContent(a){if(a.content){if(a.content.draw){a.content.draw(a.content)}}}function Click(){return globals.canvas.click(globals.canvas)}function ClickBox(b){if(b.contents){var g=ClickContents(b);if(g){return g}}var h=Get(globals.mx);var f=Get(globals.my);var e=Get(b.left);var c=Get(b.width);var d=Get(b.top);var a=Get(b.height);if(e<h&&h<e+c&&d<f&&f<d+a){return b}else{return null}}function ClickArc(c){var e=Get(globals.mx);var d=Get(globals.my);var b=Get(c.cx);var f=Get(c.cy);var a=Get(c.radius);if((e-b)*(e-b)+(d-f)*(d-f)<a*a){return c}else{return null}}function ClickContents(a){for(var b=a.contents.length-1;b>=0;b--){var c=a.contents[b];if(c.click){var d=c.click(c);if(d){return d}}}}function ClickSingletonContents(a){var b=a.contents;if(b.click){var c=b.click(b);if(c){return c}}}function ClickContent(a){var b=a.content;if(b.click){var c=b.click(b);if(c){return c}}}function PositionContents(c){for(var a in c.contents){var b=c.contents[a];if(b.position){b.position(b)}}}function DisplayButton(c,b){var a={};a.click=ClickBox;a.image=c;AddRectSlots(a);a.draw=function(e){var i=Get(e.image);var h=Get(e.left);var g=Get(e.top);var f=Get(e.width);var d=Get(e.height);globals.g.drawImage(i,h,g,f,d)};a.onhover=function(){PushCursor("pointer");Push("LD",b)};a.dehover=function(){PopCursor();Pop("LD");if(a.modehandler){Push("LD",a.modehandler)}};return a}function DisplayGram(a){var b=DisplayCell(a.value);b.data=a;b.position=PositionGram;return b}function PositionGram(b){PositionCell(b);var a=b.data;if(a.type==ParserConstants.Alt){b.stroke="rgb(255,100,0)"}else{if(a.type==ParserConstants.Opt){b.stroke="rgb(0,255,0)"}else{if(a.type==ParserConstants.Non){b.stroke="rgb(0,0,255)"}else{if(a.type==ParserConstants.Term){b.stroke="rgb(150,150,150)"}else{if(a.type==ParserConstants.Seq){b.stroke="rgb(0,0,0)"}}}}}}function PositionParserMatrixCell(c){var d=c.data;for(var b in c.path){var a=c.path[b];d=d[a]}if(d==-1){c.fill="rgb(128,128,128)"}else{if(d==0){c.fill="rgb(255,255,255)"}else{if(d==1){c.fill="rgb(255,128,0)"}else{throw new Error()}}}}function DisplayLexerNode(b){var c=MakePointer(b.parent.code,b.contents);var a=DisplayCell(c);a.dx=MakeSlot(a.code,null).contents;a.dy=MakeSlot(a.code,null).contents;return a}function DisplayLexerLabel(b){var d=DisplayCell(b.predicate);var a=DisplayCell(b.action);var c=MakeArray();c.contents[0]=d;c.contents[1]=a;return c}function DisplayCog(d){var c={};AddRectSlots(c);c.draw=DrawBox;c.fill=null;c.stroke="rgb(0,0,0)";var b={};AddRectSlots(b);b.draw=DrawBox;b.fill=null;b.stroke="rgb(0,0,0)";var a={};AddRectSlots(a);a.position=PositionCog;a.click=ClickBox;a.draw=DrawBox;a.data=d;a.left=c;a.right=b;a.contents=[c,b];return a}function PositionCog(f){Set(f.wr,Get(f.width)/2);Set(f.hr,Get(f.height)/2);Set(f.right,Get(f.left)+Get(f.width));Set(f.cx,Get(f.left)+Get(f.wr));Set(f.bottom,Get(f.top)+Get(f.height));Set(f.cy,Get(f.top)+Get(f.hr));var c=Get(f.left);var i=Get(f.top);var b=Get(f.width);var l=Get(f.height);var e=Get(f.cx);var d=Get(f.cy);var a=Get(f.bottom);var k=Get(f.right);var j=Get(f.hr);var h=Get(f.wr);f.left.left[0]=c;f.left.width[0]=h;f.left.wr[0]=h/2;f.left.right[0]=e;f.left.cx[0]=c+h/2;f.left.top[0]=i;f.left.height[0]=l;f.left.hr[0]=j;f.left.bottom[0]=a;f.left.cy[0]=d;f.right.left[0]=e-1;f.right.width[0]=h;f.right.wr[0]=h/2;f.right.right[0]=k;f.right.cx[0]=e-1+h/2;f.right.top[0]=i;f.right.height[0]=l;f.right.hr[0]=j;f.right.bottom[0]=a;f.right.cy[0]=d;var g=f.data.contents;if(g.type==Machine.Slot){if(g.state==State.Inactive){f.left.fill="rgb(70,70,70)";f.right.fill="rgb(70,70,70)"}else{if(g.state==State.Blank){f.left.fill="rgb(245,228,156)";f.right.fill="rgb(245,228,156)"}else{if(g.state==State.Setting){f.left.fill="rgb(255,194,14)";f.right.fill="rgb(245,228,156)"}else{if(g.state==State.Nonblank){f.left.fill="rgb(255,194,14)";f.right.fill="rgb(255,194,14)"}else{if(g.state==State.Blanking){f.left.fill="rgb(245,228,156)";f.right.fill="rgb(255,194,14)"}}}}}}else{if(g.type==Machine.Pointer){if(g.state==State.Inactive){f.left.fill="rgb(70,70,70)";f.right.fill="rgb(70,70,70)"}else{if(g.state==State.Blank){f.left.fill="rgb(168,230,29)";f.right.fill="rgb(168,230,29)"}else{if(g.state==State.Setting){f.left.fill="rgb(34,177,76)";f.right.fill="rgb(168,230,29)"}else{if(g.state==State.Nonblank){f.left.fill="rgb(34,177,76)";f.right.fill="rgb(34,177,76)"}else{if(g.state==State.Blanking){f.left.fill="rgb(168,230,29)";f.right.fill="rgb(34,177,76)"}else{if(g.state==State.Unbound){f.left.fill="rgb(157,187,97)";f.right.fill="rgb(157,187,97)"}}}}}}}else{if(g.type==Machine.Exp){if(g.state==State.Inactive){f.left.fill="rgb(70,70,70)";f.right.fill="rgb(70,70,70)"}else{if(g.state==State.FirstFire){f.left.fill="rgb(255,126,0)";f.right.fill="rgb(255,126,0)"}else{if(g.state==State.Waiting){f.left.fill="rgb(255,163,177)";f.right.fill="rgb(255,163,177)"}else{if(g.state==State.Firing){}else{if(g.state==State.Fired){f.left.fill="rgb(237,28,36)";f.right.fill="rgb(237,28,36)"}}}}}}else{if(g.type==Machine.Control){if(g.state==State.Inactive){f.left.fill="rgb(70,70,70)";f.right.fill="rgb(70,70,70)"}else{if(g.state==State.Activating){f.left.fill="rgb(0,183,239)";f.right.fill="rgb(70,70,70)"}else{if(g.state==State.Active){f.left.fill="rgb(0,183,239)";f.right.fill="rgb(0,183,239)"}else{if(g.state==State.Deactivating){f.left.fill="rgb(70,70,70)";f.right.fill="rgb(0,183,239)"}}}}}else{if(g.type==Machine.Equals){f.left.fill="rgb(111,49,152)";f.right.fill="rgb(111,49,152)"}}}}}}function PrimeDrag(){Push("LD",BeginDrag);Push("LU",EndDrag);Render()}function BeginDrag(){globals.beingDragged=globals.hovered;if(globals.beingDragged.dx){Set(globals.fcx,Get(globals.beingDragged.dx));Set(globals.fcy,Get(globals.beingDragged.dy))}else{Set(globals.fcx,Get(globals.beingDragged.cx));Set(globals.fcy,Get(globals.beingDragged.cy))}Set(globals.fmx,Get(globals.mx));Set(globals.fmy,Get(globals.my));Push("MM",Drag);Render()}function EndDrag(){globals.beingDragged=null;Pop("MM");Pop("LD");Pop("LU");Event("MM");Render()}function Drag(){var b=Get(globals.mx)-Get(globals.fmx);var a=Get(globals.my)-Get(globals.fmy);if(globals.beingDragged.dx){Set(globals.beingDragged.dx,Get(globals.fcx)+b);Set(globals.beingDragged.dy,Get(globals.fcy)+a)}else{Set(globals.beingDragged.cx,Get(globals.fcx)+b);Set(globals.beingDragged.cy,Get(globals.fcy)+a)}Render()}function MoveActiveUp(){var a=globals.selectedGridShape;if(a.active.row>0){a.active.row--;var b=a.cells[a.active.col*a.nRows+a.active.row];SelectThis(b)}}function MoveActiveDown(){var a=globals.selectedGridShape;if(a.active.row<a.nRows-1){a.active.row++;var b=a.cells[a.active.col*a.nRows+a.active.row];SelectThis(b)}}function MoveActiveRight(){var a=globals.selectedGridShape;if(a.active.col<a.nCols-1){a.active.col++;var b=a.cells[a.active.col*a.nRows+a.active.row];SelectThis(b)}}function MoveActiveLeft(){var a=globals.selectedGridShape;if(a.active.col>0){a.active.col--;var b=a.cells[a.active.col*a.nRows+a.active.row];SelectThis(b)}}function MoveActiveAllTheWayUp(){var a=globals.selectedGridShape;a.active.row=0;var b=a.cells[a.active.col*a.nRows+a.active.row];SelectThis(b)}function MoveActiveAllTheWayDown(){var a=globals.selectedGridShape;a.active.row=a.nRows-1;var b=a.cells[a.active.col*a.nRows+a.active.row];SelectThis(b)}function MoveActiveAllTheWayRight(){var a=globals.selectedGridShape;a.active.col=a.nCols-1;var b=a.cells[a.active.col*a.nRows+a.active.row];SelectThis(b)}function MoveActiveAllTheWayLeft(){var a=globals.selectedGridShape;a.active.col=0;var b=a.cells[a.active.col*a.nRows+a.active.row];SelectThis(b)}function ExtendSelectionUp(){var a=globals.selectedGridShape;if(a.selectionExtentCell.row>0){a.selectionExtentCell.row--}a.selected.left=Math.min(a.active.col,a.selectionExtentCell.col);a.selected.right=Math.max(a.active.col,a.selectionExtentCell.col);a.selected.top=Math.min(a.active.row,a.selectionExtentCell.row);a.selected.bottom=Math.max(a.active.row,a.selectionExtentCell.row)}function ExtendSelectionDown(){var a=globals.selectedGridShape;if(a.selectionExtentCell.row<a.nRows-1){a.selectionExtentCell.row++}a.selected.left=Math.min(a.active.col,a.selectionExtentCell.col);a.selected.right=Math.max(a.active.col,a.selectionExtentCell.col);a.selected.top=Math.min(a.active.row,a.selectionExtentCell.row);a.selected.bottom=Math.max(a.active.row,a.selectionExtentCell.row)}function ExtendSelectionRight(){var a=globals.selectedGridShape;if(a.selectionExtentCell.col<a.nCols-1){a.selectionExtentCell.col++}a.selected.left=Math.min(a.active.col,a.selectionExtentCell.col);a.selected.right=Math.max(a.active.col,a.selectionExtentCell.col);a.selected.top=Math.min(a.active.row,a.selectionExtentCell.row);a.selected.bottom=Math.max(a.active.row,a.selectionExtentCell.row)}function ExtendSelectionLeft(){var a=globals.selectedGridShape;if(a.selectionExtentCell.col>0){a.selectionExtentCell.col--}a.selected.left=Math.min(a.active.col,a.selectionExtentCell.col);a.selected.right=Math.max(a.active.col,a.selectionExtentCell.col);a.selected.top=Math.min(a.active.row,a.selectionExtentCell.row);a.selected.bottom=Math.max(a.active.row,a.selectionExtentCell.row)}function ExtendSelectionAllTheWayUp(){var a=globals.selectedGridShape;a.selectionExtentCell.row=0;a.selected.left=Math.min(a.active.col,a.selectionExtentCell.col);a.selected.right=Math.max(a.active.col,a.selectionExtentCell.col);a.selected.top=Math.min(a.active.row,a.selectionExtentCell.row);a.selected.bottom=Math.max(a.active.row,a.selectionExtentCell.row)}function ExtendSelectionAllTheWayDown(){var a=globals.selectedGridShape;a.selectionExtentCell.row=a.nRows-1;a.selected.left=Math.min(a.active.col,a.selectionExtentCell.col);a.selected.right=Math.max(a.active.col,a.selectionExtentCell.col);a.selected.top=Math.min(a.active.row,a.selectionExtentCell.row);a.selected.bottom=Math.max(a.active.row,a.selectionExtentCell.row)}function ExtendSelectionAllTheWayRight(){var a=globals.selectedGridShape;a.selectionExtentCell.col=a.nCols-1;a.selected.left=Math.min(a.active.col,a.selectionExtentCell.col);a.selected.right=Math.max(a.active.col,a.selectionExtentCell.col);a.selected.top=Math.min(a.active.row,a.selectionExtentCell.row);a.selected.bottom=Math.max(a.active.row,a.selectionExtentCell.row)}function ExtendSelectionAllTheWayLeft(){var a=globals.selectedGridShape;a.selectionExtentCell.col=0;a.selected.left=Math.min(a.active.col,a.selectionExtentCell.col);a.selected.right=Math.max(a.active.col,a.selectionExtentCell.col);a.selected.top=Math.min(a.active.row,a.selectionExtentCell.row);a.selected.bottom=Math.max(a.active.row,a.selectionExtentCell.row)}function SelectWholeCol(){var a=globals.selectedGridShape;a.selected.top=0;a.selected.bottom=a.nRows-1}function SelectWholeRow(){var a=globals.selectedGridShape;a.selected.left=0;a.selected.right=a.nCols-1}function SelectWholeGrid(){var a=globals.selectedGridShape;a.selected.top=0;a.selected.bottom=a.nRows-1;a.selected.left=0;a.selected.right=a.nCols-1}function InsertRowAbove(){var a=globals.selectedGridShape}function InsertRowBelow(){var a=globals.selectedGridShape}function InsertColRight(){var a=globals.selectedGridShape}function InsertColLeft(){var a=globals.selectedGridShape}function Select(){var a=globals.hovered;if(a.cell){a=a.cell}if(a.onselect){SelectThis(a)}}function SelectThis(a){if(globals.selected){globals.selected.deselect(globals.selected)}a.onselect(a);globals.selected=a}function Deselect(){if(globals.selected){globals.selected.deselect(globals.selected)}globals.selected=null}function ParentSelectCellShape(a){globals.selectedCellShape=a}function ParentSelectGridShape(a){globals.selectedGridShape=a;OnFocusGridShape(a)}function ParentSelectArrayShape(a){globals.selectedArrayShape=a;OnFocusArrayShape(a)}function ParentSelectRootreeShape(a){globals.selectedRootreeShape=a;OnFocusRootreeShape(a)}function ParentSelectRootShape(a){globals.selectedRootShape=a;a.parentShape.parentSelect(a.parentShape)}function ParentSelectGraphShape(a){globals.selectedGraphShape=a;OnFocusGraphShape(a)}function ParentDeselectCellShape(a){globals.selectedCellShape=null}function ParentDeselectGridShape(a){globals.selectedGridShape=null;DeFocusGridShape(a)}function ParentDeselectArrayShape(a){globals.selectedArrayShape=null;DeFocusArrayShape(a)}function ParentDeselectRootreeShape(a){globals.selectedRootreeShape=null;DeFocusRootreeShape(a)}function ParentDeselectRootShape(a){globals.selectedRootShape=null;a.parentShape.parentDeselect(a.parentShape)}function ParentDeselectGraphShape(a){globals.selectedGraphShape=null;DeFocusGraphShape(a)}function OnHoverDigit(a){OnHoverCell(a.cell);globals.hovered.oldFill=globals.hovered.fill;globals.hovered.fill="rgb(255,0,0)";Push("MW",Scroll)}function DeHoverDigit(a){DeHoverCell(a.cell);globals.hovered.fill=globals.hovered.oldFill;Pop("MW")}function OnHoverNonDigit(a){OnHoverCell(a.cell)}function DeHoverNonDigit(a){DeHoverCell(a.cell)}function PrimeScrub(){Push("MM",Scrub)}function DeactScrub(){Pop("MM")}function Scrub(){Set(globals.fmx,Get(globals.mx));var b=null;if(globals.hovered.type=="char"){b=globals.hovered.cell}else{if(globals.hovered.type=="cell"){b=globals.hovered}}globals.scrubOrigValue=b.slot[0];globals.scrubScale=1;var a=globals.scrubOrigValue+globals.scrubScale*(Get(globals.mx)-Get(globals.fmx));b.slot[0]=a;RecalculateCellString(b);RedisplayCellString(b)}function Scroll(){var d=globals.delta;var b=globals.hovered.scale;var c=globals.hovered.cell.pointer[0];var a=null;a=c[0]+d*b;c[0]=a;RecalculateCellString(globals.hovered.cell);RedisplayCellString(globals.hovered.cell);globals.hovered.cell.position(globals.hovered.cell);Event("MM")}function IsDigit(a){if(a=="0"||a=="1"||a=="2"||a=="3"||a=="4"||a=="5"||a=="6"||a=="7"||a=="8"||a=="9"){return true}else{return false}}function DeleteAndPrimeTextEditAndAddChar(){globals.beingEdited=globals.selected;Delete();PrimeTextEdit();AddChar()}function PrimeTextEdit(){var a=globals.selected;globals.beingEdited=a;globals.olds=a.string;a.cursorPosInString=a.string.length-1;a.cursorOn=true;a.cursorTimer=setInterval(a.toggleCursor,500);globals.oldAddToLog=globals.addToLog;globals.addToLog=false;PushAlpha(AddChar);Push(";:",AddChar);Push("=+",AddChar);Push(",<",AddChar);Push("-_",AddChar);Push(".>",AddChar);Push("/?",AddChar);Push("`~",AddChar);Push("[{",AddChar);Push("\\|",AddChar);Push("]}",AddChar);Push("'\"",AddChar);Push("Space",AddChar);Push("CapsLock",ToggleCapsLock);Push("Backspace",Backspace);Push("Delete",Delete);Push("Enter",AcceptEditWithEnter);Push("Esc",RejectEdit);Push("Left",MoveCursorLeft);Push("Right",MoveCursorRight);globals.addToLog=globals.oldAddToLog}function DeactTextEdit(){var a=globals.beingEdited;a.cursorOn=false;clearInterval(a.cursorTimer);globals.beingEdited=null;globals.oldAddToLog=globals.addToLog;globals.addToLog=false;PopAlpha();Pop(";:");Pop("=+");Pop(",<");Pop("-_");Pop(".>");Pop("/?");Pop("`~");Pop("[{");Pop("\\|");Pop("]}");Pop("'\"");Pop("Space");Pop("CapsLock");Pop("Backspace");Pop("Delete");Pop("Enter");Pop("Esc");Pop("Left");Pop("Right");globals.addToLog=globals.oldAddToLog}function AddChar(){var d=globals.event;var b=globals.codeToCharMapToUse[d];var a=globals.beingEdited;var c=a.string;a.string=c.substr(0,a.cursorPosInString+1)+b+c.substr(a.cursorPosInString+1);a.cursorPosInString++;RedisplayCellString(a);PositionCell(a)}function Backspace(){var a=globals.beingEdited;var b=a.string;a.string=b.substr(0,a.cursorPosInString)+b.substr(a.cursorPosInString+1);a.cursorPosInString--;RedisplayCellString(a);PositionCell(a)}function Delete(){var a=globals.selected;Set(a.pointer[0],null);RecalculateCellString(a);RedisplayCellString(a);PositionCell(a)}function MoveCursorLeft(){var a=globals.beingEdited;if(a.cursorPosInString>=0){a.cursorPosInString--}}function MoveCursorRight(){var a=globals.beingEdited;if(a.cursorPosInString<a.string.length-1){a.cursorPosInString++}}function AcceptEditWithEnter(){var a=globals.beingEdited;AcceptEdit();if(a.parentShape==globals.selectedGridShape){MoveActiveDown()}}function AcceptEdit(){var newvalue=null;var cell=globals.beingEdited;var s=cell.string;if(s==""){Set(cell.pointer[0],newvalue);cell.pointer.name=null}else{if(s[0]=="="){if(s[1]=="("){var code=CompileLisp(s.substring(1));code.rootexp.pout=cell.pointer}else{cell.pointer.name=s.substring(1)}}else{if(IsDigit(s[0])||s[0]=="."){newvalue=eval(s);Set(cell.pointer[0],newvalue);cell.pointer.name=null}else{newvalue=s;Set(cell.pointer[0],newvalue);cell.pointer.name=null}}}RecalculateCellString(cell);RedisplayCellString(cell);PositionCell(cell);DeactTextEdit()}function RejectEdit(){var a=globals.beingEdited;globals.beingEdited.string=globals.olds;RedisplayCellString(globals.beingEdited);PositionCell(a);DeactTextEdit()}function ToggleCapsLock(){if(globals.codeToCharMapToUse==globals.codeToCharMap){globals.codeToCharMapToUse=globals.codeToCharMapShift}else{globals.codeToCharMapToUse=globals.codeToCharMap}}function CheckHover(){var a=Click();if(a){if(a!=globals.hovered){if(globals.hovered&&globals.hovered.dehover){globals.hovered.dehover(globals.hovered)}globals.hovered=a;if(a.onhover){a.onhover(a)}}}else{if(globals.hovered){if(globals.hovered.dehover){globals.hovered.dehover(globals.hovered);globals.hovered=null}globals.hovered=null}}}function Push(b,a){if(globals.addToLog){globals.log.push("Push "+b+" "+a.name)}if(!globals.actions[b]){globals.actions[b]=[]}globals.actions[b].push(a)}function PushAlpha(a){Push("0",a);Push("1",a);Push("2",a);Push("3",a);Push("4",a);Push("5",a);Push("6",a);Push("7",a);Push("8",a);Push("9",a);Push("A",a);Push("B",a);Push("C",a);Push("D",a);Push("E",a);Push("F",a);Push("G",a);Push("H",a);Push("I",a);Push("J",a);Push("K",a);Push("L",a);Push("M",a);Push("N",a);Push("O",a);Push("P",a);Push("Q",a);Push("R",a);Push("S",a);Push("T",a);Push("U",a);Push("V",a);Push("W",a);Push("X",a);Push("Y",a);Push("Z",a)}function PopAlpha(a){Pop("0");Pop("1");Pop("2");Pop("3");Pop("4");Pop("5");Pop("6");Pop("7");Pop("8");Pop("9");Pop("A");Pop("B");Pop("C");Pop("D");Pop("E");Pop("F");Pop("G");Pop("H");Pop("I");Pop("J");Pop("K");Pop("L");Pop("M");Pop("N");Pop("O");Pop("P");Pop("Q");Pop("R");Pop("S");Pop("T");Pop("U");Pop("V");Pop("W");Pop("X");Pop("Y");Pop("Z")}function Pop(b){var a=globals.actions[b].pop();if(globals.addToLog){globals.log.push("Pop "+b+" "+a.name)}}function PushUnder(a,b){a.push(a[a.length-1]);a[a.length-2]=b}function PopUnder(a){a[a.length-2]=a[a.length-1];a.pop()}function PushCursor(a){globals.cursorStack.push(a);document.getElementById("myCanvas").style.cursor=a}function PopCursor(){globals.cursorStack.pop();document.getElementById("myCanvas").style.cursor=globals.cursorStack[globals.cursorStack.length-1]}function MoveGap(a){if(a.x-globals.canvasLeft!=Get(globals.mx)||a.Y-globals.canvasTop!=Get(globals.my)){Set(globals.mx,a.x-globals.canvasLeft);Set(globals.my,a.y-globals.canvasTop);Event("MM")}}function ShiftOn(){globals.shift=true;globals.codeToCharMapToUse=globals.codeToCharMapShift}function ShiftOff(){globals.shift=false;globals.codeToCharMapToUse=globals.codeToCharMap}function CtrlOn(){globals.ctrl=true}function CtrlOff(){globals.ctrl=false}function AltOn(){globals.alt=true}function AltOff(){globals.alt=false}function Event(c){if(c=="Shift"||c=="Ctrl"||c=="Alt"||c=="-Shift"||c=="-Ctrl"||c=="-Alt"){}else{if(globals.alt){c="Alt+"+c}if(globals.ctrl){c="Ctrl+"+c}if(globals.shift){c="Shift+"+c}}if(c!="MM"){if(globals.addToLog){globals.log.push(c)}}globals.event=c;var a=globals.actions[c];if(a&&a.length>0){var b=a[a.length-1];b()}Render()}function KeyDown(b){var a=globals.keyValueToCode[b.keyCode];if(a){Event(a);b.preventDefault()}}function KeyUp(b){var a=globals.keyValueToCode[b.keyCode];if(a){Event("-"+a);b.preventDefault()}}function MouseDown(a){MoveGap(a);if(a.button==0){Event("LD")}else{if(a.button==2){Event("RD")}else{throw new Error()}}a.preventDefault()}function MouseUp(a){MoveGap(a);if(a.button==0){Event("LU")}else{if(a.button==2){Event("RU")}else{throw new Error()}}a.preventDefault()}function MouseMove(a){Set(globals.mx,a.x-globals.canvasLeft);Set(globals.my,a.y-globals.canvasTop);Event("MM");a.preventDefault()}function MouseWheel(a){globals.delta=a.wheelDelta/120;Event("MW");a.preventDefault()}function Tick(){}var State={};State.Inactive=0;State.Blank=1;State.Setting=2;State.Nonblank=3;State.Blanking=4;State.Unbound=5;State.Activating=6;State.Active=7;State.Deactivating=8;State.FirstFire=9;State.Waiting=10;State.Firing=11;State.Fired=12;var Machine={};Machine.Slot=0;Machine.Pointer=1;Machine.Exp=2;Machine.Control=3;Machine.Equals=4;var queue=[];var newqueue=[];function Calculate(){var c=false;while(queue.length>0){for(var b in queue){var a=queue[b];a.contents.act(a)}queue=newqueue;newqueue=[]}}function MakeSlot(c,b){var d={};d.type=Machine.Slot;d.state=State.Inactive;d.act=ProcessSlot;d[0]=b;var a=MakeNode(d);if(c){AddNode(c,a)}d.node=a;return a}function MakePointer(d,f,b,c){var e={};e.type=Machine.Pointer;e.state=State.Inactive;e.act=ProcessPointer;e.name=b;e.scope=c;var a=MakeNode(e);if(d){AddNode(d,a)}if(f){e[0]=f;if(d){AddEdge(d,a,f.node,"0")}}e.node=a;return a}function MakeExp(b){var c={};c.type=Machine.Exp;c.state=State.Inactive;c.act=ProcessExp;c.pout=null;c.f=null;c.args=[];var a=MakeNode(c);AddNode(b,a);c.node=a;return a}function MakeControl(b){var c={};c.type=Machine.Control;c.state=State.Inactive;c.act=ProcessControl;var a=MakeNode(c);AddNode(b,a);c.node=a;return a}function MakeEquals(g,i,f,e,d){var h={};h.type=Machine.Equals;h.state=State.Inactive;h.act=ProcessEquals;h.op=i;h.total=f;h.a=e;h.b=d;var c=MakeNode(h);AddNode(g,c);AddEdge(g,c,f.node,"total");AddEdge(g,c,e.node,"a");if(d){AddEdge(g,c,d.node,"b")}h.node=c;return c}function ProcessSlot(a){}function ProcessPointer(a){}function ProcessExp(a){}function ProcessControl(a){}function ProcessEquals(a){}function AddCode(a){globals.code.push(a)}function Lock(a){a.locked=true}document.onkeydown=KeyDown;document.onkeyup=KeyUp;document.getElementById("myCanvas").onmousedown=MouseDown;document.getElementById("myCanvas").onmouseup=MouseUp;document.getElementById("myCanvas").onmousemove=MouseMove;document.getElementById("myCanvas").onmousewheel=MouseWheel;var globals={};GlobalsDriver();function GlobalsDriver(){globals.canvasElement=document.getElementById("myCanvas");globals.g=globals.canvasElement.getContext("2d");globals.canvasLeft=0;globals.canvasTop=0;globals.code=[];globals.addToLog=false;globals.log=[];globals.logStart=0;globals.logDisplayLines=40;globals.selected=null;globals.selectedGridShape=null;globals.selectedArrayShape=null;globals.selectedTreeShape=null;globals.selectedRootShape=null;globals.selectedGraphShape=null;globals.selectedNodeShape=null;globals.selectedEdgeShape=null;globals.canvas={};globals.canvas.data=globals;globals.canvas.position=PositionContents;globals.canvas.draw=DrawBox;globals.canvas.click=ClickBox;globals.canvas.contents=[];globals.shapeCreationTree={contents:[],parent:null,children:[]};globals.drawClickTree={contents:{type:"canvas"},parent:null,firstChild:null,lastChild:null,nextSibling:null,prevSibling:null,drawParams:{},clickParams:{}};globals.shapeMoveTree={contents:[],parent:null,children:[]};globals.reader=new FileReader();globals.focusBox=null;globals.shift=false;globals.ctrl=false;globals.alt=false;globals.mouseCode=MakeGraph();globals.mx=MakeSlot(globals.mouseCode,0).contents;globals.my=MakeSlot(globals.mouseCode,0).contents;globals.fmx=MakeSlot(globals.mouseCode,0).contents;globals.fmy=MakeSlot(globals.mouseCode,0).contents;globals.fcx=MakeSlot(globals.mouseCode,0).contents;globals.fcy=MakeSlot(globals.mouseCode,0).contents;globals.delta=0;globals.oldx=0;globals.oldy=0;globals.hovered=null;globals.beingEdited=null;globals.cursor=0;globals.cursorOn=false;globals.field=null;globals.origStrBeingEdited=null;globals.actions={};globals.keyValueToCode=[];globals.codeToCharMap={};globals.codeToCharMapShift={};globals.codeToCharMapToUse=globals.codeToCharMap;globals.charge=10;globals.optimalSpringLength=50;globals.springStiffness=10;globals.actions.TK=[];globals.actions.MM=[CheckHover];globals.actions.MW=[];globals.actions.LD=[];globals.actions.LU=[];globals.actions.RD=[];globals.actions.RU=[];globals.actions.Backspace=[];globals.actions.Tab=[];globals.actions.Enter=[];globals.actions.Shift=[ShiftOn];globals.actions.Ctrl=[CtrlOn];globals.actions.Alt=[AltOn];globals.actions["-Shift"]=[ShiftOff];globals.actions["-Ctrl"]=[CtrlOff];globals.actions["-Alt"]=[AltOff];globals.actions.CapsLock=[];globals.actions.Esc=[];globals.actions.Space=[];globals.actions.PageUp=[];globals.actions.PageDown=[];globals.actions.End=[];globals.actions.Home=[];globals.actions.Left=[];globals.actions.Up=[];globals.actions.Right=[];globals.actions.Down=[];globals.actions.Insert=[];globals.actions.Delete=[];globals.keyValueToCode[8]="Backspace";globals.keyValueToCode[9]="Tab";globals.keyValueToCode[13]="Enter";globals.keyValueToCode[16]="Shift";globals.keyValueToCode[17]="Ctrl";globals.keyValueToCode[18]="Alt";globals.keyValueToCode[20]="CapsLock";globals.keyValueToCode[27]="Esc";globals.keyValueToCode[32]="Space";globals.keyValueToCode[33]="PageUp";globals.keyValueToCode[34]="PageDown";globals.keyValueToCode[35]="End";globals.keyValueToCode[36]="Home";globals.keyValueToCode[37]="Left";globals.keyValueToCode[38]="Up";globals.keyValueToCode[39]="Right";globals.keyValueToCode[40]="Down";globals.keyValueToCode[45]="Insert";globals.keyValueToCode[46]="Delete";globals.keyValueToCode[186]=";:";globals.keyValueToCode[187]="=+";globals.keyValueToCode[188]=",<";globals.keyValueToCode[189]="-_";globals.keyValueToCode[190]=".>";globals.keyValueToCode[191]="/?";globals.keyValueToCode[192]="`~";globals.keyValueToCode[219]="[{";globals.keyValueToCode[220]="\\|";globals.keyValueToCode[221]="]}";globals.keyValueToCode[222]="'\"";globals.keyValueToCode[113]="F2";globals.keyValueToCode[48]="0";globals.keyValueToCode[49]="1";globals.keyValueToCode[50]="2";globals.keyValueToCode[51]="3";globals.keyValueToCode[52]="4";globals.keyValueToCode[53]="5";globals.keyValueToCode[54]="6";globals.keyValueToCode[55]="7";globals.keyValueToCode[56]="8";globals.keyValueToCode[57]="9";globals.keyValueToCode[65]="A";globals.keyValueToCode[66]="B";globals.keyValueToCode[67]="C";globals.keyValueToCode[68]="D";globals.keyValueToCode[69]="E";globals.keyValueToCode[70]="F";globals.keyValueToCode[71]="G";globals.keyValueToCode[72]="H";globals.keyValueToCode[73]="I";globals.keyValueToCode[74]="J";globals.keyValueToCode[75]="K";globals.keyValueToCode[76]="L";globals.keyValueToCode[77]="M";globals.keyValueToCode[78]="N";globals.keyValueToCode[79]="O";globals.keyValueToCode[80]="P";globals.keyValueToCode[81]="Q";globals.keyValueToCode[82]="R";globals.keyValueToCode[83]="S";globals.keyValueToCode[84]="T";globals.keyValueToCode[85]="U";globals.keyValueToCode[86]="V";globals.keyValueToCode[87]="W";globals.keyValueToCode[88]="X";globals.keyValueToCode[89]="Y";globals.keyValueToCode[90]="Z";globals.codeToCharMap.A="a";globals.codeToCharMap.B="b";globals.codeToCharMap.C="c";globals.codeToCharMap.D="d";globals.codeToCharMap.E="e";globals.codeToCharMap.F="f";globals.codeToCharMap.G="g";globals.codeToCharMap.H="h";globals.codeToCharMap.I="i";globals.codeToCharMap.J="j";globals.codeToCharMap.K="k";globals.codeToCharMap.L="l";globals.codeToCharMap.M="m";globals.codeToCharMap.N="n";globals.codeToCharMap.O="o";globals.codeToCharMap.P="p";globals.codeToCharMap.Q="q";globals.codeToCharMap.R="r";globals.codeToCharMap.S="s";globals.codeToCharMap.T="t";globals.codeToCharMap.U="u";globals.codeToCharMap.V="v";globals.codeToCharMap.W="w";globals.codeToCharMap.X="x";globals.codeToCharMap.Y="y";globals.codeToCharMap.Z="z";globals.codeToCharMap["0"]="0";globals.codeToCharMap["1"]="1";globals.codeToCharMap["2"]="2";globals.codeToCharMap["3"]="3";globals.codeToCharMap["4"]="4";globals.codeToCharMap["5"]="5";globals.codeToCharMap["6"]="6";globals.codeToCharMap["7"]="7";globals.codeToCharMap["8"]="8";globals.codeToCharMap["9"]="9";globals.codeToCharMap[";:"]=";";globals.codeToCharMap["=+"]="=";globals.codeToCharMap[",<"]=",";globals.codeToCharMap["-_"]="-";globals.codeToCharMap[".>"]=".";globals.codeToCharMap["/?"]="/";globals.codeToCharMap["`~"]="`";globals.codeToCharMap["[{"]="[";globals.codeToCharMap["\\|"]="\\";globals.codeToCharMap["]}"]="]";globals.codeToCharMap["'\""]="'";globals.codeToCharMap.Space=" ";globals.codeToCharMapShift.A="A";globals.codeToCharMapShift.B="B";globals.codeToCharMapShift.C="C";globals.codeToCharMapShift.D="D";globals.codeToCharMapShift.E="E";globals.codeToCharMapShift.F="F";globals.codeToCharMapShift.G="G";globals.codeToCharMapShift.H="H";globals.codeToCharMapShift.I="I";globals.codeToCharMapShift.J="J";globals.codeToCharMapShift.K="K";globals.codeToCharMapShift.L="L";globals.codeToCharMapShift.M="M";globals.codeToCharMapShift.N="N";globals.codeToCharMapShift.O="O";globals.codeToCharMapShift.P="P";globals.codeToCharMapShift.Q="Q";globals.codeToCharMapShift.R="R";globals.codeToCharMapShift.S="S";globals.codeToCharMapShift.T="T";globals.codeToCharMapShift.U="U";globals.codeToCharMapShift.V="V";globals.codeToCharMapShift.W="W";globals.codeToCharMapShift.X="X";globals.codeToCharMapShift.Y="Y";globals.codeToCharMapShift.Z="Z";globals.codeToCharMapShift["0"]=")";globals.codeToCharMapShift["1"]="!";globals.codeToCharMapShift["2"]="@";globals.codeToCharMapShift["3"]="#";globals.codeToCharMapShift["4"]="$";globals.codeToCharMapShift["5"]="%";globals.codeToCharMapShift["6"]="^";globals.codeToCharMapShift["7"]="&";globals.codeToCharMapShift["8"]="*";globals.codeToCharMapShift["9"]="(";globals.codeToCharMapShift[";:"]=":";globals.codeToCharMapShift["=+"]="+";globals.codeToCharMapShift[",<"]="<";globals.codeToCharMapShift["-_"]="_";globals.codeToCharMapShift[".>"]=">";globals.codeToCharMapShift["/?"]="?";globals.codeToCharMapShift["`~"]="~";globals.codeToCharMapShift["[{"]="{";globals.codeToCharMapShift["\\|"]="|";globals.codeToCharMapShift["]}"]="}";globals.codeToCharMapShift["'\""]='"';globals.codeToCharMapShift.Space=" "}function Render(){globals.g.clearRect(0,0,globals.canvasElement.width,globals.canvasElement.height);globals.canvas.draw(globals.canvas);globals.g.fillStyle="rgb(0,0,0)";globals.logy=15;globals.logStart=globals.log.length-globals.logDisplayLines;if(globals.logStart<0){globals.logStart=0}for(var a=globals.logStart;a<globals.log.length;a++){globals.g.fillText(globals.log[a],1300,globals.logy);globals.logy+=15}}function Get(b){if(!b){return b}var a=typeof(b);if(a=="object"){return Get(b[0])}else{return b}}function Set(b,a){b[0]=a}function MoveBox(a,c,b){Set(a[c],b);if(c=="left"){Set(a.cx,Get(a.left)+Get(a.wr));Set(a.right,Get(a.left)+Get(a.width))}else{if(c=="cx"){Set(a.left,Get(a.cx)-Get(a.wr));Set(a.right,Get(a.cx)+Get(a.wr))}else{if(c=="right"){Set(a.left,Get(a.right)-Get(a.width));Set(a.cx,Get(a.right)-Get(a.wr))}else{if(c=="top"){Set(a.cy,Get(a.top)+Get(a.hr));Set(a.bottom,Get(a.top)+Get(a.height))}else{if(c=="cy"){Set(a.top,Get(a.cy)-Get(a.hr));Set(a.bottom,Get(a.cy)+Get(a.hr))}else{if(c=="bottom"){Set(a.top,Get(a.bottom)-Get(a.height));Set(a.cy,Get(a.bottom)-Get(a.hr))}}}}}}}function SizeBox(b,d,a,c){Set(b[d],c);if(d=="width"){Set(b.wr,c/2);if(a=="left"){Set(b.cx,Get(b.left)+Get(b.wr));Set(b.right,Get(b.left)+Get(b.width))}else{if(a=="cx"){Set(b.left,Get(b.cx)-Get(b.wr));Set(b.right,Get(b.cx)+Get(b.wr))}else{if(a=="right"){Set(b.left,Get(b.right)-Get(b.width));Set(b.cx,Get(b.right)-Get(b.wr))}}}}else{if(d=="height"){Set(b.hr,c/2);if(a=="top"){Set(b.cy,Get(b.top)+Get(b.hr));Set(b.bottom,Get(b.top)+Get(b.height))}else{if(a=="cy"){Set(b.top,Get(b.cy)-Get(b.hr));Set(b.bottom,Get(b.cy)+Get(b.hr))}else{if(a=="bottom"){Set(b.top,Get(b.bottom)-Get(b.height));Set(b.cy,Get(b.bottom)-Get(b.hr))}}}}else{if(d=="wr"){Set(b.width,c*2);if(a=="left"){Set(b.cx,Get(b.left)+Get(b.wr));Set(b.right,Get(b.left)+Get(b.width))}else{if(a=="cx"){Set(b.left,Get(b.cx)-Get(b.wr));Set(b.right,Get(b.cx)+Get(b.wr))}else{if(a=="right"){Set(b.left,Get(b.right)-Get(b.width));Set(b.cx,Get(b.right)-Get(b.wr))}}}}else{if(d=="hr"){Set(b.height,c*2);if(a=="top"){Set(b.cy,Get(b.top)+Get(b.hr));Set(b.bottom,Get(b.top)+Get(b.height))}else{if(a=="cy"){Set(b.top,Get(b.cy)-Get(b.hr));Set(b.bottom,Get(b.cy)+Get(b.hr))}else{if(a=="bottom"){Set(b.top,Get(b.bottom)-Get(b.height));Set(b.cy,Get(b.bottom)-Get(b.hr))}}}}else{if(d=="left"){if(a=="cx"){Set(b.wr,Get(b.cx)-Get(b.left));Set(b.width,Get(b.wr)*2);Set(b.right,Get(b.left)+Get(b.width))}else{if(a=="right"){Set(b.width,Get(b.right)-Get(b.left));Set(b.wr,Get(b.width)/2);Set(b.cx,Get(b.left)+Get(b.wr))}}}else{if(d=="cx"){if(a=="left"){Set(b.wr,Get(b.cx)-Get(b.left));Set(b.width,Get(b.wr)*2);Set(b.right,Get(b.left)+Get(b.width))}else{if(a=="right"){Set(b.wr,Get(b.right)-Get(b.cx));Set(b.width,Get(b.wr)*2);Set(b.left,Get(b.right)-Get(b.width))}}}else{if(d=="right"){if(a=="cx"){Set(b.wr,Get(b.right)-Get(b.cx));Set(b.width,Get(b.wr)*2);Set(b.left,Get(b.right)-Get(b.width))}else{if(a=="left"){Set(b.width,Get(b.right)-Get(b.left));Set(b.wr,Get(b.width)/2);Set(b.cx,Get(b.left)+Get(b.wr))}}}else{if(d=="top"){if(a=="cy"){Set(b.hr,Get(b.cy)-Get(b.top));Set(b.height,Get(b.hr)*2);Set(b.bottom,Get(b.top)+Get(b.height))}else{if(a=="bottom"){Set(b.height,Get(b.bottom)-Get(b.top));Set(b.hr,Get(b.height)/2);Set(b.cy,Get(b.top)+Get(b.hr))}}}else{if(d=="cy"){if(a=="top"){Set(b.hr,Get(b.cy)-Get(b.top));Set(b.height,Get(b.hr)*2);Set(b.bottom,Get(b.top)+Get(b.height))}else{if(a=="bottom"){Set(b.hr,Get(b.bottom)-Get(b.cy));Set(b.height,Get(b.hr)*2);Set(b.top,Get(b.bottom)-Get(b.height))}}}else{if(d=="bottom"){if(a=="cy"){Set(b.hr,Get(b.bottom)-Get(b.cy));Set(b.height,Get(b.hr)*2);Set(b.top,Get(b.bottom)-Get(b.height))}else{if(a=="top"){Set(b.height,Get(b.bottom)-Get(b.top));Set(b.hr,Get(b.height)/2);Set(b.cy,Get(b.top)+Get(b.hr))}}}}}}}}}}}}}function SetFields(b,c){for(var a in c){b[a]=c[a]}}function AddRectSlots(a){a.code=MakeGraph();a.left=MakeSlot(a.code,null).contents;a.top=MakeSlot(a.code,null).contents;a.width=MakeSlot(a.code,null).contents;a.height=MakeSlot(a.code,null).contents;a.cx=MakeSlot(a.code,null).contents;a.cy=MakeSlot(a.code,null).contents;a.bottom=MakeSlot(a.code,null).contents;a.right=MakeSlot(a.code,null).contents;a.hr=MakeSlot(a.code,null).contents;a.wr=MakeSlot(a.code,null).contents;a.lineWidth=1;MakeEquals(a.code,"=+",a.cx,a.left,a.wr);MakeEquals(a.code,"=+",a.right,a.cx,a.wr);MakeEquals(a.code,"=+",a.right,a.left,a.width);MakeEquals(a.code,"*2",a.width,a.wr);MakeEquals(a.code,"=+",a.cy,a.top,a.hr);MakeEquals(a.code,"=+",a.bottom,a.cy,a.hr);MakeEquals(a.code,"=+",a.bottom,a.top,a.height);MakeEquals(a.code,"*2",a.height,a.hr);AddCode(a.code)}function LoadFile(){if(document.getElementById("fileChooser").files.length===0){return}var a=document.getElementById("fileChooser").files[0];globals.reader.readAsArrayBuffer(a)}function Ajax(){if(window.XMLHttpRequest){xmlhttp=new XMLHttpRequest()}else{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4&&xmlhttp.status==200){}};xmlhttp.open("GET","ajax",true);xmlhttp.send()}function ReadFromServer(a){if(window.XMLHttpRequest){xmlhttp=new XMLHttpRequest()}else{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4&&xmlhttp.status==200){var b=a.substring(a.lastIndexOf("/"));b=b.substring(0,b.length-5);globals[b]=JSON.parse(xmlhttp.responseText)}};xmlhttp.open("GET",a,true);xmlhttp.send()}function WriteToServer(c,a){if(window.XMLHttpRequest){xmlhttp=new XMLHttpRequest()}else{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}if(a.substring(a.length-5)!=".json"){return}var b=JSON.stringify(c);xmlhttp.open("PUT",a,true);xmlhttp.send(b)}function WriteBlobToServer(a,b){if(window.XMLHttpRequest){xmlhttp=new XMLHttpRequest()}else{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}xmlhttp.open("PUT",b,true);xmlhttp.send(a)}function Nop(){}function Remove(b,d){var a=b.indexOf(d);var c=b.slice(0,a).concat(b.slice(a+1));return c}Init();function Init(){var m={};AddRectSlots(m);m.stroke="rgb(0,0,0)";SizeBox(m,"width","cx",600);SizeBox(m,"height","cy",600);MoveBox(m,"top",50);MoveBox(m,"left",800);globals.asteroidsGame=m;m.code=MakeGraph();m.ships=[];m.asteroids=[];m.bullets=[];m.init={};m.init.nAsteroids=MakeSlot(m.code,5).contents;m.init.veloMin=MakeSlot(m.code,-2).contents;m.init.veloMax=MakeSlot(m.code,2).contents;m.init.initRadius=MakeSlot(m.code,30).contents;m.ship={};m.ship.bulletVelocity=MakeSlot(m.code,10).contents;m.ship.bulletRadius=MakeSlot(m.code,2).contents;m.ship.bulletLifeInSeconds=MakeSlot(m.code,1.5).contents;m.ship.forwardAcceleration=MakeSlot(m.code,1).contents;m.ship.backwardAcceleration=MakeSlot(m.code,1).contents;m.ship.rotationVelocity=MakeSlot(m.code,10).contents;m.breaking={};m.breaking.childAsteroids=MakeSlot(m.code,2).contents;m.breaking.radiusDiminishment=MakeSlot(m.code,10).contents;m.breaking.childVelocityDiffMin=MakeSlot(m.code,-1).contents;m.breaking.childVelocityDiffMax=MakeSlot(m.code,1).contents;m.draw=DrawGame;globals.canvas.contents.push(m);NewGame(m);var g={};g.obj=m;g.objs=["ship"];g.fields=["bulletVelocity","bulletRadius","bulletLifeInSeconds","forwardAcceleration","backwardAcceleration","rotationVelocity"];g.cols=g.objs;g.rows=g.fields;var h=DisplayGrid(g);h.rowLabelWidth=150;MoveBox(h,"top",320);MoveBox(h,"left",20);globals.canvas.contents.push(h);var e={};e.obj=m;e.objs=["breaking"];e.fields=["childAsteroids","radiusDiminishment","childVelocityDiffMin","childVelocityDiffMax"];e.cols=e.objs;e.rows=e.fields;var k=DisplayGrid(e);k.rowLabelWidth=150;MoveBox(k,"top",320);MoveBox(k,"left",280);globals.canvas.contents.push(k);var l={};l.obj=m.ships;l.objs=[];for(var f in l.obj){l.objs.push(f)}l.fields=["cx","cy","vx","vy","ori"];l.cols=l.fields;l.rows=l.objs;var c=DisplayGrid(l);MoveBox(c,"top",50);MoveBox(c,"left",50);globals.canvas.contents.push(c);var d={};d.obj=m.asteroids;d.objs=[];for(var f in d.obj){d.objs.push(f)}d.fields=["cx","cy","vx","vy","radius"];d.cols=d.fields;d.rows=d.objs;var b=DisplayGrid(d);MoveBox(b,"top",150);MoveBox(b,"left",50);globals.canvas.contents.push(b);var a=MakeSlot(m.code,"function FireForwardThrusters()\n{\nvar ship = globals.asteroidsGame.ships[0];\nSet(ship.vx, Get(ship.vx) + Get(globals.asteroidsGame.ship.forwardAcceleration) * Math.cos(Get(ship.ori)));\nSet(ship.vy, Get(ship.vy) - Get(globals.asteroidsGame.ship.forwardAcceleration) * Math.sin(Get(ship.ori)));\n}\n").contents;var j=DisplayCell(a);j.parentShape=j;j.parentSelect=ParentSelectCellShape;j.parentDeselect=ParentDeselectCellShape;j.editActive=Nop;MoveBox(j,"left",20);MoveBox(j,"top",500);SizeBox(j,"width","left",700);SizeBox(j,"height","top",150);RecalculateCellString(j);RedisplayCellString(j);globals.canvas.contents.push(j);m.shipsGridShape=c;m.asteroidsGridShape=b;m.interval=30;m.timer=setInterval(AsteroidsTick,m.interval);m.live=true;Push("Up",ForwardThrusters);Push("Down",BackwardThrusters);Push("Right",StartTurnClockwiseTimer);Push("Left",StartTurnCounterclockwiseTimer);Push("-Right",StopRotationTimer);Push("-Left",StopRotationTimer);Push("S",StopRotationTimer);Push("Space",Fire);Push("Enter",TogglePause);m.paused=false;globals.canvas.position(globals.canvas)}function TogglePause(){if(globals.asteroidsGame.live){globals.asteroidsGame.live=false}else{globals.asteroidsGame.live=true}}function ForwardThrusters(){var a=globals.asteroidsGame.ships[0];Set(a.vx,Get(a.vx)+Get(globals.asteroidsGame.ship.forwardAcceleration)*Math.cos(Get(a.ori)));Set(a.vy,Get(a.vy)-Get(globals.asteroidsGame.ship.forwardAcceleration)*Math.sin(Get(a.ori)))}function BackwardThrusters(){var a=globals.asteroidsGame.ships[0];Set(a.vx,Get(a.vx)-Get(globals.asteroidsGame.ship.backwardAcceleration)*Math.cos(Get(a.ori)));Set(a.vy,Get(a.vy)+Get(globals.asteroidsGame.ship.backwardAcceleration)*Math.sin(Get(a.ori)))}function StartTurnClockwiseTimer(){globals.asteroidsGame.rotationTimer=setInterval(TurnClockwise,30);Pop("Right");Pop("Left")}function StartTurnCounterclockwiseTimer(){globals.asteroidsGame.rotationTimer=setInterval(TurnCounterclockwise,30);Pop("Right");Pop("Left")}function StopRotationTimer(){clearInterval(globals.asteroidsGame.rotationTimer);Push("Right",StartTurnClockwiseTimer);Push("Left",StartTurnCounterclockwiseTimer)}function TurnClockwise(){var a=globals.asteroidsGame.ships[0];Set(a.ori,Get(a.ori)-Get(globals.asteroidsGame.ship.rotationVelocity)/360*2*Math.PI)}function TurnCounterclockwise(){var a=globals.asteroidsGame.ships[0];Set(a.ori,Get(a.ori)+Get(globals.asteroidsGame.ship.rotationVelocity)/360*2*Math.PI)}function Fire(){var b=globals.asteroidsGame;var c=globals.asteroidsGame.ships[0];var a={};a.cx=MakeSlot(b.code,Get(c.cx)).contents;a.cy=MakeSlot(b.code,Get(c.cy)).contents;a.vx=MakeSlot(b.code,Get(globals.asteroidsGame.ship.bulletVelocity)*Math.cos(Get(c.ori))).contents;a.vy=MakeSlot(b.code,-Get(globals.asteroidsGame.ship.bulletVelocity)*Math.sin(Get(c.ori))).contents;a.radius=MakeSlot(b.code,Get(b.ship.bulletRadius)).contents;a.life=Get(b.ship.bulletLifeInSeconds);b.bullets.push(a)}function AsteroidsTick(){var a=globals.asteroidsGame;if(a.live){AsteroidsUpdate()}Render()}function AsteroidsUpdate(){var n=globals.asteroidsGame;for(var g in n.ships){var f=n.ships[g];Set(f.cx,Get(f.cx)+Get(f.vx));Set(f.cy,Get(f.cy)+Get(f.vy));if(Get(f.cx)<Get(n.left)){Set(f.cx,Get(f.cx)+Get(n.width))}if(Get(f.cx)>Get(n.right)){Set(f.cx,Get(f.cx)-Get(n.width))}if(Get(f.cy)<Get(n.top)){Set(f.cy,Get(f.cy)+Get(n.height))}if(Get(f.cy)>Get(n.bottom)){Set(f.cy,Get(f.cy)-Get(n.height))}for(var e in n.asteroids){var a=n.asteroids[e];var d=(Get(f.cx)-Get(a.cx))*(Get(f.cx)-Get(a.cx))+(Get(f.cy)-Get(a.cy))*(Get(f.cy)-Get(a.cy));if(d<(Get(a.radius)+Get(f.radius))*(Get(a.radius)+Get(f.radius))){n.live=false}}}for(var g in n.asteroids){var f=n.asteroids[g];Set(f.cx,Get(f.cx)+Get(f.vx));Set(f.cy,Get(f.cy)+Get(f.vy));if(Get(f.cx)<Get(n.left)){Set(f.cx,Get(f.cx)+Get(n.width))}if(Get(f.cx)>Get(n.right)){Set(f.cx,Get(f.cx)-Get(n.width))}if(Get(f.cy)<Get(n.top)){Set(f.cy,Get(f.cy)+Get(n.height))}if(Get(f.cy)>Get(n.bottom)){Set(f.cy,Get(f.cy)-Get(n.height))}}var h=[];for(var g=0;g<n.bullets.length;g++){var f=n.bullets[g];if(f.life<=0){h.push(f);continue}else{f.life-=n.interval/1000}Set(f.cx,Get(f.cx)+Get(f.vx));Set(f.cy,Get(f.cy)+Get(f.vy));if(Get(f.cx)<Get(n.left)){Set(f.cx,Get(f.cx)+Get(n.width))}if(Get(f.cx)>Get(n.right)){Set(f.cx,Get(f.cx)-Get(n.width))}if(Get(f.cy)<Get(n.top)){Set(f.cy,Get(f.cy)+Get(n.height))}if(Get(f.cy)>Get(n.bottom)){Set(f.cy,Get(f.cy)-Get(n.height))}for(var e in n.asteroids){var a=n.asteroids[e];var d=(Get(f.cx)-Get(a.cx))*(Get(f.cx)-Get(a.cx))+(Get(f.cy)-Get(a.cy))*(Get(f.cy)-Get(a.cy));if(d<Get(f.radius)*Get(f.radius)+Get(a.radius)*Get(a.radius)){var l=Get(n.breaking.childVelocityDiffMin);var o=Get(n.breaking.childVelocityDiffMax);for(var c=0;c<Get(n.breaking.childAsteroids);c++){var b={};b.cx=MakeSlot(n.code,Get(a.cx)).contents;b.cy=MakeSlot(n.code,Get(a.cy)).contents;b.vx=MakeSlot(n.code,Get(a.vx)+Get(f.vx)/10+l+(o-l)*Math.random()).contents;b.vy=MakeSlot(n.code,Get(a.vy)+Get(f.vy)/10+l+(o-l)*Math.random()).contents;b.radius=MakeSlot(n.code,Get(a.radius)-Get(n.breaking.radiusDiminishment)).contents;if(Get(b.radius)>0){n.asteroids.push(b)}}n.asteroids=Remove(n.asteroids,a);h.push(f);break}}}for(var g in h){n.bullets=Remove(n.bullets,h[g])}for(var g in n.shipsGridShape.cells){var m=n.shipsGridShape.cells[g];RecalculateCellString(m);RedisplayCellString(m)}n.shipsGridShape.position(n.shipsGridShape);for(var g in n.asteroidsGridShape.cells){var m=n.asteroidsGridShape.cells[g];RecalculateCellString(m);RedisplayCellString(m)}n.asteroidsGridShape.position(n.asteroidsGridShape)}function NewGame(h){var b=Get(h.cx);var k=Get(h.cy);h.ships[0]={};h.ships[0].cx=MakeSlot(h.code,b).contents;h.ships[0].cy=MakeSlot(h.code,k).contents;h.ships[0].vx=MakeSlot(h.code,0).contents;h.ships[0].vy=MakeSlot(h.code,0).contents;h.ships[0].radius=MakeSlot(h.code,20).contents;h.ships[0].ori=MakeSlot(h.code,Math.PI/2).contents;var f=Get(h.init.veloMin);var j=Get(h.init.veloMax);for(var e=0;e<Get(h.init.nAsteroids);e++){var d=b;var c=k;while((d-b)*(d-b)+(c-k)*(c-k)<100){d=Get(h.left)+Get(h.width)*Math.random();c=Get(h.top)+Get(h.height)*Math.random()}var g={};g.cx=MakeSlot(h.code,d).contents;g.cy=MakeSlot(h.code,c).contents;g.vx=MakeSlot(h.code,f+(j-f)*Math.random()).contents;g.vy=MakeSlot(h.code,f+(j-f)*Math.random()).contents;g.radius=MakeSlot(h.code,Get(h.init.initRadius)).contents;h.asteroids.push(g)}}function DrawGame(c){var e=globals.g;DrawBox(c);for(var d in c.ships){var f=c.ships[d];e.strokeStyle="rgb(255,0,0)";e.beginPath();e.moveTo(Get(f.cx)+Get(f.radius)*Math.cos(Get(f.ori)+0*Math.PI/3),Get(f.cy)-Get(f.radius)*Math.sin(Get(f.ori)+0*Math.PI/3));e.lineTo(Get(f.cx)+Get(f.radius)*Math.cos(Get(f.ori)+2*Math.PI/3),Get(f.cy)-Get(f.radius)*Math.sin(Get(f.ori)+2*Math.PI/3));e.lineTo(Get(f.cx)+Get(f.radius)*Math.cos(Get(f.ori)+4*Math.PI/3),Get(f.cy)-Get(f.radius)*Math.sin(Get(f.ori)+4*Math.PI/3));e.closePath();e.stroke();e.beginPath();e.moveTo(Get(f.cx),Get(f.cy));e.lineTo(Get(f.cx)+Get(f.radius)*Math.cos(Get(f.ori)+0*Math.PI/3),Get(f.cy)-Get(f.radius)*Math.sin(Get(f.ori)+0*Math.PI/3));e.stroke()}for(var d in c.asteroids){var a=c.asteroids[d];e.strokeStyle="rgb(0,0,0)";e.beginPath();e.arc(Get(a.cx),Get(a.cy),Get(a.radius),0,2*Math.PI,true);e.closePath();e.stroke()}for(var d in c.bullets){var b=c.bullets[d];e.fillStyle="rgb(255,0,0)";e.beginPath();e.arc(Get(b.cx),Get(b.cy),Get(b.radius),0,2*Math.PI,true);e.closePath();e.fill()}};